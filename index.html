<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…’åº—å¸ƒè‰åˆ†æ´¾ç³»çµ±-Terryho5693</title>
    <style>
        :root {
            --primary-color: #211551;
            --secondary-color: #34a853;
            --accent-color: #FFC107;
            --danger-color: #ea4335;
            --light-bg: #f8f9fa;
            --border-color: #d1d1e0;
            --text-on-primary: #ffffff;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .input-section {
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: var(--light-bg);
        }
        
        input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-align: center;
        }
        
        /* ç¦ç”¨æ•°å­—è¾“å…¥æ¡†çš„å¢å‡æŒ‰é’® */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .floor-tag {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            background-color: #e9ecef;
            transition: all 0.2s;
        }
        
        .floor-tag.excluded {
            background-color: #ffe3e3;
            color: var(--danger-color);
            text-decoration: line-through;
        }
        
        .settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--light-bg);
            border-radius: 8px;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
        }
        
        .setting-item label {
            margin-right: 10px;
            font-weight: bold;
            min-width: 120px;
        }
        
        .setting-item input, .setting-item select {
            flex: 1;
            max-width: 100px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        
        .preview-section {
            margin-top: 30px;
        }
        
        .preview-container {
            overflow-x: auto;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .preview-table {
            min-width: 100%;
        }
        
        .preview-table th {
            position: sticky;
            top: 0;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            background-color: #3367d6;
        }
        
        .action-btn.export {
            background-color: var(--secondary-color);
        }
        
        .action-btn.export:hover {
            background-color: #2d9246;
        }
        
        .total-ratio {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .error {
            color: var(--danger-color);
        }
        
        /* æ–°å¢ç‹¬ç«‹ä»½æ•°æ¨¡å¼æ ·å¼ */
        .floor-ratio-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            grid-column: 1 / -1;
        }
        
        .floor-ratio-item {
            display: flex;
            align-items: center;
        }
        
        .floor-ratio-item label {
            min-width: 40px;
            margin-right: 5px;
            font-weight: bold;
        }
        
        .floor-ratio-item input {
            width: 60px;
            padding: 5px;
        }
        
        .ratio-group-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            grid-column: 1 / -1;
        }
        
        .ratio-presets {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            grid-column: 1 / -1;
        }
        
        .preset-btn {
            padding: 5px 10px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background: #d0d0d0;
        }
        
        @media (max-width: 768px) {
            .settings {
                grid-template-columns: 1fr;
            }
            
            table, .preview-table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .floor-ratio-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å¸ƒè‰åˆ†æ´¾ç³»çµ±,Created by 4742015-HKTEHO,æœ‰æŒ‘å‰”æ—¢,è«‹æŒ‰å³ä¸Šè§’Xæ»¾å‡ºå»è‡ªå·±è¨ˆ</h1>
        
        <div class="input-section">
            <table id="inputTable">
                <thead>
                    <tr>
                        <th>é …ç›®</th>
                        <th>æ´—å›</th>
                        <th>ç¿»æ´—</th>
                        <th>ç¸½æ•¸</th>
                        <th>2F</th>
                        <th>è²§çª®æ¨“å±¤</th>
                    </tr>
                </thead>
                <tbody id="itemRows">
                    <!-- é …ç›®è¡Œå°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <div class="settings">
            <div class="setting-item">
                <label for="baseRatio">è¨­å®šç¸½åŸºæº–ä»½æ•¸ï¼š</label>
                <input type="number" id="baseRatio" min="0" step="1" value="27">
            </div>
            
            <div class="setting-item">
                <label for="ratioMode">æ¯”ä¾‹æ¨¡å¼ï¼š</label>
                <select id="ratioMode">
                    <option value="group">åˆ†çµ„æ¨¡å¼</option>
                    <option value="individual">ç¨ç«‹æ¨¡å¼</option>
                </select>
            </div>
            
            <!-- åˆ†çµ„æ¯”ä¾‹è¨­ç½® -->
            <div id="groupRatios" class="ratio-group-container">
                <div class="setting-item">
                    <label for="f5Ratio">5F ä»½æ•¸ï¼š</label>
                    <input type="number" id="f5Ratio" min="0" step="0.1" value="1.0">
                </div>
                <div class="setting-item">
                    <label for="f6_15Ratio">6Fâ€“15F ä»½æ•¸ï¼š</label>
                    <input type="number" id="f6_15Ratio" min="0" step="0.1" value="1.5">
                </div>
                <div class="setting-item">
                    <label for="f16_26Ratio">16Fâ€“26F ä»½æ•¸ï¼š</label>
                    <input type="number" id="f16_26Ratio" min="0" step="0.1" value="1.0">
                </div>
            </div>
            
            <!-- ç¨ç«‹æ¨“å±¤æ¯”ä¾‹è¨­ç½® -->
            <div id="individualRatios" class="floor-ratio-container" style="display:none;">
                <!-- æ¨“å±¤æ¯”ä¾‹è¼¸å…¥å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <!-- æ¯”ä¾‹é è¨­æŒ‰éˆ• -->
            <div class="ratio-presets">
                <button class="preset-btn" data-preset="default">é»˜èªæ¯”ä¾‹</button>
                <button class="preset-btn" data-preset="uniform">çµ±ä¸€æ¯”ä¾‹</button>
                <button class="preset-btn" data-preset="high-middle">ä¸­é«˜æ¨“å±¤åŠ é‡</button>
            </div>
        </div>
        
        <div class="total-ratio" id="totalRatio">åˆ†æ´¾ç¸½ä»½æ•¸ï¼š0.0</div>
        
        <div class="action-buttons">
            <button class="action-btn export" id="exportExcel">
                <span>ğŸ“Š</span> å°å‡ºExcel
            </button>
        </div>
        
        <div class="preview-section">
            <h2>å³æ™‚æ´¾å½©</h2>
            <div class="preview-container">
                <table class="preview-table" id="previewTable">
                    <thead>
                        <tr id="previewHeader">
                            <!-- é è¦½è¡¨é ­å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                        </tr>
                    </thead>
                    <tbody id="previewBody">
                        <!-- é è¦½å…§å®¹å°‡ç”±JavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å¸¸é‡å®šç¾©
        const ITEMS = ["å¤§åºŠå–®", "ç´°åºŠå–®", "å¤§è¢«è¢‹", "ç´°è¢«è¢‹", "æ•é ­è¢‹", "å¤§æ¯›å·¾", "ä¸­æ¯›å·¾", "åœ°å·¾", "æµ´è¢"];
        const FLOORS = ["2F"].concat(Array.from({length: 22}, (_, i) => `${i+5}F`));
        
        // æ‡‰ç”¨ç‹€æ…‹
        const state = {
            items: {},
            floorRatios: {}, // å­˜å„²æ¯å€‹æ¨“å±¤çš„ç¨ç«‹æ¯”ä¾‹
            excludedFloors: {},
            ratioMode: "group" // 'group' æˆ– 'individual'
        };
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        function initApp() {
            // åˆå§‹åŒ–ç‹€æ…‹
            ITEMS.forEach(item => {
                state.items[item] = {
                    washed: 0,
                    rewashed: 0,
                    manual: 0,
                    total: 0
                };
                
                state.excludedFloors[item] = {};
                FLOORS.forEach(floor => {
                    if (floor !== "2F") {
                        state.excludedFloors[item][floor] = false;
                    }
                });
            });
            
            // åˆå§‹åŒ–æ¨“å±¤æ¯”ä¾‹
            initFloorRatios();
            
            // æ¸²æŸ“è¼¸å…¥è¡¨æ ¼
            renderInputTable();
            
            // æ¸²æŸ“é è¦½è¡¨æ ¼
            renderPreviewTable();
            
            // ç¶å®šäº‹ä»¶
            bindEvents();
            
            // åˆå§‹è¨ˆç®—
            updateTotalRatio();
            updatePreview();
        }
        
        // åˆå§‹åŒ–æ¨“å±¤æ¯”ä¾‹
        function initFloorRatios() {
            FLOORS.forEach(floor => {
                if (floor === "2F") return;
                
                const floorNum = parseInt(floor);
                // è¨­ç½®é»˜èªå€¼
                if (floorNum === 5) state.floorRatios[floor] = 1.0;
                else if (floorNum >= 6 && floorNum <= 15) state.floorRatios[floor] = 1.5;
                else if (floorNum >= 16 && floorNum <= 26) state.floorRatios[floor] = 1.0;
            });
            
            renderFloorRatioInputs();
        }
        
        // æ¸²æŸ“æ¨“å±¤æ¯”ä¾‹è¼¸å…¥
        function renderFloorRatioInputs() {
            const container = document.getElementById("individualRatios");
            container.innerHTML = "";
            
            Object.keys(state.floorRatios).sort((a, b) => parseInt(a) - parseInt(b)).forEach(floor => {
                const item = document.createElement("div");
                item.className = "floor-ratio-item";
                
                const label = document.createElement("label");
                label.textContent = floor;
                item.appendChild(label);
                
                const input = document.createElement("input");
                input.type = "number";
                input.min = "0";
                input.step = "0.1";
                input.value = state.floorRatios[floor];
                input.dataset.floor = floor;
                item.appendChild(input);
                
                container.appendChild(item);
            });
        }
        
        // æ¸²æŸ“è¼¸å…¥è¡¨æ ¼
        function renderInputTable() {
            const tbody = document.getElementById("itemRows");
            tbody.innerHTML = "";
            
            ITEMS.forEach((item, index) => {
                const row = document.createElement("tr");
                
                // é …ç›®åç¨±
                const nameCell = document.createElement("td");
                nameCell.textContent = item;
                row.appendChild(nameCell);
                
                // æ´—å›è¼¸å…¥
                const washedCell = document.createElement("td");
                const washedInput = document.createElement("input");
                washedInput.type = "number";
                washedInput.min = "0";
                washedInput.value = "0";
                washedInput.dataset.item = item;
                washedInput.dataset.type = "washed";
                washedInput.dataset.row = index;
                washedInput.dataset.col = 0;
                washedCell.appendChild(washedInput);
                row.appendChild(washedCell);
                
                // ç¿»æ´—è¼¸å…¥
                const rewashedCell = document.createElement("td");
                const rewashedInput = document.createElement("input");
                rewashedInput.type = "number";
                rewashedInput.min = "0";
                rewashedInput.value = "0";
                rewashedInput.dataset.item = item;
                rewashedInput.dataset.type = "rewashed";
                rewashedInput.dataset.row = index;
                rewashedInput.dataset.col = 1;
                rewashedCell.appendChild(rewashedInput);
                row.appendChild(rewashedCell);
                
                // ç¸½æ•¸
                const totalCell = document.createElement("td");
                totalCell.textContent = "0";
                totalCell.dataset.item = item;
                totalCell.dataset.type = "total";
                row.appendChild(totalCell);
                
                // 2F
                const manualCell = document.createElement("td");
                const manualInput = document.createElement("input");
                manualInput.type = "number";
                manualInput.min = "0";
                manualInput.value = "0";
                manualInput.dataset.item = item;
                manualInput.dataset.type = "manual";
                manualInput.dataset.row = index;
                manualInput.dataset.col = 2;
                manualCell.appendChild(manualInput);
                row.appendChild(manualCell);
                
                // æ’é™¤æ¨“å±¤
                const excludeCell = document.createElement("td");
                excludeCell.className = "exclude-floors";
                FLOORS.forEach(floor => {
                    if (floor === "2F") return;
                    
                    const floorTag = document.createElement("span");
                    floorTag.className = "floor-tag";
                    floorTag.textContent = floor;
                    floorTag.dataset.item = item;
                    floorTag.dataset.floor = floor;
                    excludeCell.appendChild(floorTag);
                });
                row.appendChild(excludeCell);
                
                tbody.appendChild(row);
            });
        }
        
        // æ¸²æŸ“é è¦½è¡¨æ ¼
        function renderPreviewTable() {
            const headerRow = document.getElementById("previewHeader");
            headerRow.innerHTML = "";
            
            // æ·»åŠ è¡¨é ­
            const itemHeader = document.createElement("th");
            itemHeader.textContent = "é …ç›®";
            headerRow.appendChild(itemHeader);
            
            FLOORS.forEach(floor => {
                const th = document.createElement("th");
                th.textContent = floor;
                headerRow.appendChild(th);
            });
            
            const totalHeader = document.createElement("th");
            totalHeader.textContent = "ç¸½æ•¸";
            headerRow.appendChild(totalHeader);
            
            // æ·»åŠ é …ç›®è¡Œ
            const tbody = document.getElementById("previewBody");
            tbody.innerHTML = "";
            
            ITEMS.forEach(item => {
                const row = document.createElement("tr");
                
                // é …ç›®åç¨±
                const nameCell = document.createElement("td");
                nameCell.textContent = item;
                row.appendChild(nameCell);
                
                // æ¨“å±¤æ•¸æ“š
                FLOORS.forEach(floor => {
                    const td = document.createElement("td");
                    td.textContent = "0";
                    td.dataset.item = item;
                    td.dataset.floor = floor;
                    row.appendChild(td);
                });
                
                // ç¸½æ•¸
                const totalCell = document.createElement("td");
                totalCell.textContent = "0";
                totalCell.dataset.item = item;
                totalCell.dataset.type = "preview-total";
                row.appendChild(totalCell);
                
                tbody.appendChild(row);
            });
        }
        
        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            // æ•¸å­—è¼¸å…¥æ¡†è®ŠåŒ–
            document.querySelectorAll("input[type='number']").forEach(input => {
                input.addEventListener("change", handleInputChange);
                input.addEventListener("input", handleInputChange);
                // æ·»åŠ Enteréµäº‹ä»¶ç›£è½
                input.addEventListener("keydown", handleKeyDown);
                // é˜»æ­¢é¼ æ ‡æ»šè½®æ”¹å˜æ•°å­—è¾“å…¥æ¡†çš„å€¼
                input.addEventListener("wheel", function(e) {
                    e.preventDefault();
                });
            });
            
            // æ¨“å±¤æ¨™ç±¤é»æ“Š
            document.querySelectorAll(".floor-tag").forEach(tag => {
                tag.addEventListener("click", toggleExcludeFloor);
            });
            
            // Excelå°å‡ºæŒ‰éˆ•
            document.getElementById("exportExcel").addEventListener("click", exportToExcel);
            
            // åŸºæº–ä»½æ•¸è®ŠåŒ–
            document.getElementById("baseRatio").addEventListener("change", updateBaseRatio);
            
            // æ¯”ä¾‹æ¨¡å¼åˆ‡æ›
            document.getElementById("ratioMode").addEventListener("change", toggleRatioMode);
            
            // åˆ†çµ„æ¯”ä¾‹è®ŠåŒ–
            document.getElementById("f5Ratio").addEventListener("change", handleGroupRatioChange);
            document.getElementById("f6_15Ratio").addEventListener("change", handleGroupRatioChange);
            document.getElementById("f16_26Ratio").addEventListener("change", handleGroupRatioChange);
            
            // ç¨ç«‹æ¯”ä¾‹è®ŠåŒ–
            document.addEventListener("change", function(e) {
                if (e.target.matches("#individualRatios input[type='number']")) {
                    updateFloorRatio(e);
                }
            });
            
            document.addEventListener("input", function(e) {
                if (e.target.matches("#individualRatios input[type='number']")) {
                    updateFloorRatio(e);
                }
            });
            
            // æ¯”ä¾‹é è¨­æŒ‰éˆ•
            document.querySelectorAll(".preset-btn").forEach(btn => {
                btn.addEventListener("click", applyRatioPreset);
            });
        }
        
        // è™•ç†éµç›¤äº‹ä»¶ï¼ˆEnteréµè·³è½‰ï¼‰ - å·²ä¿®æ”¹ä¸ºæŒ‰é¡¹ç›®é¡ºåºè·³è½¬
        function handleKeyDown(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                const currentInput = e.target;
                const currentRow = parseInt(currentInput.dataset.row);
                const currentCol = parseInt(currentInput.dataset.col);
                
                // ç²å–æ‰€æœ‰è¼¸å…¥æ¡†
                const inputs = document.querySelectorAll("#itemRows input[type='number']");
                
                // è¨ˆç®—ä¸‹ä¸€å€‹è¼¸å…¥æ¡†çš„ç´¢å¼•ï¼ˆä¸‹ä¸€è¡Œçš„åŒä¸€åˆ—ï¼‰
                let nextIndex = -1;
                
                // å¦‚æœé‚„æœ‰ä¸‹ä¸€è¡Œï¼Œè·³è½‰åˆ°ä¸‹ä¸€è¡Œçš„åŒä¸€åˆ—
                if (currentRow < ITEMS.length - 1) {
                    nextIndex = (currentRow + 1) * 3 + currentCol;
                }
                
                // å¦‚æœæ‰¾åˆ°ä¸‹ä¸€å€‹è¼¸å…¥æ¡†ï¼Œèšç„¦å®ƒ
                if (nextIndex >= 0 && nextIndex < inputs.length) {
                    inputs[nextIndex].focus();
                    inputs[nextIndex].select();
                }
            }
        }
        
        // è™•ç†è¼¸å…¥è®ŠåŒ–
        function handleInputChange(e) {
            const input = e.target;
            const item = input.dataset.item;
            const type = input.dataset.type;
            const value = parseInt(input.value) || 0;
            
            // æ›´æ–°ç‹€æ…‹
            state.items[item][type] = value;
            
            // å¦‚æœæ˜¯æ´—å›æˆ–ç¿»æ´—ï¼Œæ›´æ–°ç¸½æ•¸
            if (type === "washed" || type === "rewashed") {
                updateItemTotal(item);
            }
            
            // æ›´æ–°é è¦½
            updatePreview();
        }
        
        // æ›´æ–°é …ç›®ç¸½æ•¸
        function updateItemTotal(item) {
            const total = state.items[item].washed + state.items[item].rewashed;
            state.items[item].total = total;
            
            // æ›´æ–°UI
            document.querySelector(`td[data-item="${item}"][data-type="total"]`).textContent = total;
        }
        
        // åˆ‡æ›æ’é™¤æ¨“å±¤
        function toggleExcludeFloor(e) {
            const tag = e.target;
            const item = tag.dataset.item;
            const floor = tag.dataset.floor;
            
            // æ›´æ–°ç‹€æ…‹
            state.excludedFloors[item][floor] = !state.excludedFloors[item][floor];
            
            // æ›´æ–°UI
            tag.classList.toggle("excluded", state.excludedFloors[item][floor]);
            
            // æ›´æ–°é è¦½
            updatePreview();
        }
        
        // æ›´æ–°åŸºæº–ä»½æ•¸
        function updateBaseRatio() {
            const baseRatio = parseInt(document.getElementById("baseRatio").value) || 0;
            updateTotalRatio();
            updatePreview();
        }
        
        // åˆ‡æ›æ¯”ä¾‹æ¨¡å¼
        function toggleRatioMode() {
            const mode = document.getElementById("ratioMode").value;
            state.ratioMode = mode;
            
            if (mode === "group") {
                document.getElementById("groupRatios").style.display = "grid";
                document.getElementById("individualRatios").style.display = "none";
                syncGroupToIndividual();
            } else {
                document.getElementById("groupRatios").style.display = "none";
                document.getElementById("individualRatios").style.display = "grid";
                syncIndividualToGroup();
            }
            
            updateTotalRatio();
            updatePreview();
        }
        
        // åˆ†çµ„æ¯”ä¾‹åŒæ­¥åˆ°ç¨ç«‹æ¯”ä¾‹
        function syncGroupToIndividual() {
            const f5Ratio = parseFloat(document.getElementById("f5Ratio").value) || 0;
            const f6_15Ratio = parseFloat(document.getElementById("f6_15Ratio").value) || 0;
            const f16_26Ratio = parseFloat(document.getElementById("f16_26Ratio").value) || 0;
            
            Object.keys(state.floorRatios).forEach(floor => {
                const floorNum = parseInt(floor);
                if (floorNum === 5) {
                    state.floorRatios[floor] = f5Ratio;
                } else if (floorNum >= 6 && floorNum <= 15) {
                    state.floorRatios[floor] = f6_15Ratio;
                } else if (floorNum >= 16 && floorNum <= 26) {
                    state.floorRatios[floor] = f16_26Ratio;
                }
            });
            
            renderFloorRatioInputs();
        }
        
        // ç¨ç«‹æ¯”ä¾‹åŒæ­¥åˆ°åˆ†çµ„æ¯”ä¾‹
        function syncIndividualToGroup() {
            let f5Ratio = 0, f6_15Ratio = 0, f16_26Ratio = 0;
            let f5Count = 0, f6_15Count = 0, f16_26Count = 0;
            
            Object.keys(state.floorRatios).forEach(floor => {
                const floorNum = parseInt(floor);
                if (floorNum === 5) {
                    f5Ratio += state.floorRatios[floor];
                    f5Count++;
                } else if (floorNum >= 6 && floorNum <= 15) {
                    f6_15Ratio += state.floorRatios[floor];
                    f6_15Count++;
                } else if (floorNum >= 16 && floorNum <= 26) {
                    f16_26Ratio += state.floorRatios[floor];
                    f16_26Count++;
                }
            });
            
            // è¨ˆç®—å¹³å‡å€¼
            document.getElementById("f5Ratio").value = f5Count > 0 ? (f5Ratio / f5Count).toFixed(1) : "0";
            document.getElementById("f6_15Ratio").value = f6_15Count > 0 ? (f6_15Ratio / f6_15Count).toFixed(1) : "0";
            document.getElementById("f16_26Ratio").value = f16_26Count > 0 ? (f16_26Ratio / f16_26Count).toFixed(1) : "0";
        }
        
        // åˆ†çµ„æ¯”ä¾‹è®ŠåŒ–è™•ç†
        function handleGroupRatioChange() {
            if (state.ratioMode === "group") {
                syncGroupToIndividual();
                updateTotalRatio();
                updatePreview();
            }
        }
        
        // æ›´æ–°æ¨“å±¤æ¯”ä¾‹
        function updateFloorRatio(e) {
            const input = e.target;
            const floor = input.dataset.floor;
            state.floorRatios[floor] = parseFloat(input.value) || 0;
            updateTotalRatio();
            updatePreview();
        }
        
        // æ‡‰ç”¨æ¯”ä¾‹é è¨­
        function applyRatioPreset(e) {
            const preset = e.target.dataset.preset;
            
            if (state.ratioMode === "group") {
                // åˆ†çµ„æ¨¡å¼æ‡‰ç”¨é è¨­
                switch(preset) {
                    case "default":
                        document.getElementById("f5Ratio").value = "1.0";
                        document.getElementById("f6_15Ratio").value = "1.5";
                        document.getElementById("f16_26Ratio").value = "1.0";
                        break;
                        
                    case "uniform":
                        document.getElementById("f5Ratio").value = "1.0";
                        document.getElementById("f6_15Ratio").value = "1.0";
                        document.getElementById("f16_26Ratio").value = "1.0";
                        break;
                        
                    case "high-middle":
                        document.getElementById("f5Ratio").value = "1.0";
                        document.getElementById("f6_15Ratio").value = "1.8";
                        document.getElementById("f16_26Ratio").value = "1.2";
                        break;
                }
                handleGroupRatioChange();
            } else {
                // ç¨ç«‹æ¨¡å¼æ‡‰ç”¨é è¨­
                switch(preset) {
                    case "default":
                        updateAllFloorRatios(floor => {
                            const num = parseInt(floor);
                            if (num === 5) return 1.0;
                            if (num >= 6 && num <= 15) return 1.5;
                            return 1.0;
                        });
                        break;
                        
                    case "uniform":
                        updateAllFloorRatios(() => 1.0);
                        break;
                        
                    case "high-middle":
                        updateAllFloorRatios(floor => {
                            const num = parseInt(floor);
                            if (num === 5) return 1.0;
                            if (num >= 6 && num <= 15) return 1.8;
                            return 1.2;
                        });
                        break;
                }
            }
        }
        
        // æ›´æ–°æ‰€æœ‰æ¨“å±¤æ¯”ä¾‹
        function updateAllFloorRatios(getRatio) {
            Object.keys(state.floorRatios).forEach(floor => {
                const ratio = getRatio(floor);
                state.floorRatios[floor] = ratio;
                
                // æ›´æ–°UI
                const input = document.querySelector(`#individualRatios input[data-floor="${floor}"]`);
                if (input) input.value = ratio;
            });
            
            updateTotalRatio();
            updatePreview();
        }
        
        // æ›´æ–°ç¸½ä»½æ•¸é¡¯ç¤º
        function updateTotalRatio() {
            let totalRatio = 0;
            
            if (state.ratioMode === "group") {
                const f5Ratio = parseFloat(document.getElementById("f5Ratio").value) || 0;
                const f6_15Ratio = parseFloat(document.getElementById("f6_15Ratio").value) || 0;
                const f16_26Ratio = parseFloat(document.getElementById("f16_26Ratio").value) || 0;
                
                // è¨ˆç®—ç¸½ä»½æ•¸ (5Fæœ‰1å€‹æ¨“å±¤ï¼Œ6-15Fæœ‰10å€‹æ¨“å±¤ï¼Œ16-26Fæœ‰11å€‹æ¨“å±¤)
                totalRatio = f5Ratio + (f6_15Ratio * 10) + (f16_26Ratio * 11);
            } else {
                // ç¨ç«‹æ¨¡å¼è¨ˆç®—ç¸½ä»½æ•¸
                totalRatio = Object.values(state.floorRatios).reduce((sum, ratio) => sum + ratio, 0);
            }
            
            document.getElementById("totalRatio").textContent = `åˆ†æ´¾ç¸½ä»½æ•¸ï¼š${totalRatio.toFixed(1)}`;
        }
        
        // æ›´æ–°é è¦½
        function updatePreview() {
            ITEMS.forEach(item => {
                const itemData = state.items[item];
                const total = itemData.total;
                const manualQty = itemData.manual;
                const remaining = Math.max(0, total - manualQty);
                
                // è¨ˆç®—å„æ¨“å±¤æ¯”ä¾‹
                const floorRatios = {};
                FLOORS.forEach(floor => {
                    if (floor === "2F") return;
                    if (state.excludedFloors[item][floor]) return;
                    
                    if (state.ratioMode === "group") {
                        // åˆ†çµ„æ¨¡å¼ä½¿ç”¨åˆ†çµ„æ¯”ä¾‹
                        const floorNum = parseInt(floor);
                        if (floorNum === 5) {
                            floorRatios[floor] = parseFloat(document.getElementById("f5Ratio").value) || 0;
                        } else if (floorNum >= 6 && floorNum <= 15) {
                            floorRatios[floor] = parseFloat(document.getElementById("f6_15Ratio").value) || 0;
                        } else if (floorNum >= 16 && floorNum <= 26) {
                            floorRatios[floor] = parseFloat(document.getElementById("f16_26Ratio").value) || 0;
                        }
                    } else {
                        // ç¨ç«‹æ¨¡å¼ä½¿ç”¨ç¨ç«‹æ¯”ä¾‹
                        floorRatios[floor] = state.floorRatios[floor] || 0;
                    }
                });
                
                const totalRatio = Object.values(floorRatios).reduce((sum, r) => sum + r, 0);
                
                // åˆ†é…æ•¸é‡
                const assigned = {};
                let rowTotal = manualQty;
                
                if (totalRatio > 0 && remaining > 0) {
                    // åŸºç¤åˆ†é…
                    Object.keys(floorRatios).forEach(floor => {
                        assigned[floor] = Math.floor(remaining * floorRatios[floor] / totalRatio);
                    });
                    
                    // è™•ç†é¤˜æ•¸
                    const remainder = remaining - Object.values(assigned).reduce((sum, qty) => sum + qty, 0);
                    const sortedFloors = Object.keys(floorRatios).sort((a, b) => floorRatios[b] - floorRatios[a]);
                    
                    for (let i = 0; i < remainder; i++) {
                        const floor = sortedFloors[i % sortedFloors.length];
                        assigned[floor] = (assigned[floor] || 0) + 1;
                    }
                    
                    rowTotal += Object.values(assigned).reduce((sum, qty) => sum + qty, 0);
                }
                
                // æ›´æ–°é è¦½UI
                FLOORS.forEach(floor => {
                    const cell = document.querySelector(`td[data-item="${item}"][data-floor="${floor}"]`);
                    
                    if (floor === "2F") {
                        cell.textContent = manualQty;
                        cell.className = "";
                    } else if (state.excludedFloors[item][floor]) {
                        cell.textContent = "â›”";
                        cell.className = "error";
                    } else {
                        cell.textContent = assigned[floor] || "0";
                        cell.className = "";
                    }
                });
                
                // æ›´æ–°ç¸½æ•¸
                document.querySelector(`td[data-item="${item}"][data-type="preview-total"]`).textContent = rowTotal;
            });
        }
        
        // Excelå°å‡ºåŠŸèƒ½
        function exportToExcel() {
            // å‰µå»ºå·¥ä½œç°¿HTML
            let html = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                  xmlns:x="urn:schemas-microsoft-com:office:excel" 
                  xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta charset="UTF-8">
                <!--[if gte mso 9]>
                <xml>
                    <x:ExcelWorkbook>
                        <x:ExcelWorksheets>
                            <x:ExcelWorksheet>
                                <x:Name>å¸ƒè‰åˆ†æ´¾æ•¸æ“š</x:Name>
                                <x:WorksheetOptions>
                                    <x:DisplayGridlines/>
                                    <x:PageSetup>
                                        <x:Layout x:Orientation="Landscape"/>
                                        <x:FitToPage/>
                                        <x:FitWidth>1</x:FitWidth>
                                        <x:FitHeight>32767</x:FitHeight>
                                        <x:Print>
                                            <x:ValidPrinterInfo/>
                                            <x:PaperSizeIndex>9</x:PaperSizeIndex>
                                            <x:HorizontalResolution>600</x:HorizontalResolution>
                                            <x:VerticalResolution>600</x:VerticalResolution>
                                        </x:Print>
                                    </x:PageSetup>
                                </x:WorksheetOptions>
                            </x:ExcelWorksheet>
                        </x:ExcelWorksheets>
                    </x:ExcelWorkbook>
                </xml>
                <![endif]-->
                <style>
                    @media print {
                        @page {
                            size: A4 landscape !important;
                            margin: 1cm !important;
                        }
                        body {
                            transform: scale(0.95);
                            transform-origin: 0 0;
                        }
                    }
                    table {
                        border-collapse: collapse;
                        width: 2400px;
                        table-layout: fixed;
                        page-break-inside: avoid !important;
                    }
                    th, td {
                        border: 1px solid black;
                        padding: 4px 8px !important;
                        word-wrap: break-word;
                    }
                    th {
                        background-color: #4CAF50;
                        color: white;
                        font-weight: bold;
                    }
                    .total {
                        background-color: #E0F7FA;
                        font-weight: bold;
                    }
                    .excluded {
                        color: #FF0000;
                        text-decoration: line-through;
                    }
                </style>
            </head>
            <body>
                <div style="font-size:14pt;font-weight:bold;text-align:center;margin-bottom:10px;">
                    é…’åº—å¸ƒè‰åˆ†æ´¾æ•¸æ“š
                </div>
                <div style="font-size:10pt;text-align:center;margin-bottom:15px;">
                    ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString()}
                </div>
                
                <table>
                    <colgroup>
                        <col width="120">
                        ${FLOORS.map(() => `<col width="70">`).join('')}
                        <col width="80">
                        <col width="80">
                        <col width="100">
                    </colgroup>
                    <tr>
                        <th>é …ç›®</th>
                        ${FLOORS.map(floor => `<th>${floor}</th>`).join('')}
                        <th>é€å›</th>
                        <th>ç¿»æ´—</th>
                        <th>ç¸½æ•¸</th>
                        <th>å·®ç•°ï¼ˆ-xï¼‰</th>
                    </tr>
                    ${ITEMS.map(item => {
                        const itemData = state.items[item];
                        const total = itemData.total;
                        const manualQty = itemData.manual;
                        const remaining = Math.max(0, total - manualQty);
                        
                        const floorRatios = {};
                        FLOORS.forEach(floor => {
                            if (floor === "2F") return;
                            if (state.excludedFloors[item][floor]) return;
                            
                            floorRatios[floor] = state.floorRatios[floor] || 0;
                        });
                        
                        const totalRatio = Object.values(floorRatios).reduce((sum, r) => sum + r, 0);
                        const assigned = {};
                        let rowTotal = manualQty;
                        
                        if (totalRatio > 0 && remaining > 0) {
                            Object.keys(floorRatios).forEach(floor => {
                                assigned[floor] = Math.floor(remaining * floorRatios[floor] / totalRatio);
                            });
                            
                            const remainder = remaining - Object.values(assigned).reduce((sum, qty) => sum + qty, 0);
                            const sortedFloors = Object.keys(floorRatios).sort((a, b) => floorRatios[b] - floorRatios[a]);
                            
                            for (let i = 0; i < remainder; i++) {
                                const floor = sortedFloors[i % sortedFloors.length];
                                assigned[floor] = (assigned[floor] || 0) + 1;
                            }
                            
                            rowTotal += Object.values(assigned).reduce((sum, qty) => sum + qty, 0);
                        }
                        
                        // è¨ˆç®—æ¬„ä½å€¼
                        const sentBack = itemData.washed;
                        const rewashed = itemData.rewashed;
                        const totalQuantity = sentBack + rewashed;
                        const difference = total - rowTotal;
                        
                        return `
                        <tr style="height:20px">
                            <td>${item}</td>
                            ${FLOORS.map(floor => {
                                if (floor === "2F") {
                                    return `<td>${manualQty}</td>`;
                                } else if (state.excludedFloors[item][floor]) {
                                    return `<td class="excluded">0</td>`;
                                } else {
                                    return `<td>${assigned[floor] || 0}</td>`;
                                }
                            }).join('')}
                            <td>${sentBack}</td>
                            <td>${rewashed}</td>
                            <td class="total">${totalQuantity}</td>
                            <td>${difference < 0 ? difference : ''}</td>
                        </tr>
                        `;
                    }).join('')}
                </table>
                
                <br>
                
                <table style="width: auto; margin-left: auto; margin-right: auto;">
                    <tr>
                        <th colspan="2" style="text-align: center;">ç³»çµ±è¨­ç½®</th>
                    </tr>
                    <tr>
                        <td>ç¸½åŸºæº–ä»½æ•¸</td>
                        <td>${document.getElementById('baseRatio').value}</td>
                    </tr>
                    <tr>
                        <td>æ¯”ä¾‹æ¨¡å¼</td>
                        <td>${state.ratioMode === 'group' ? 'åˆ†çµ„æ¨¡å¼' : 'ç¨ç«‹æ¨¡å¼'}</td>
                    </tr>
                    <tr>
                        <td>åˆ†æ´¾ç¸½ä»½æ•¸</td>
                        <td>${document.getElementById('totalRatio').textContent.split('ï¼š')[1]}</td>
                    </tr>
                </table>
                
                <br>
                
                ${state.ratioMode === 'group' ? `
                <table style="width: auto; margin-left: auto; margin-right: auto;">
                    <tr>
                        <th>åˆ†çµ„</th>
                        <th>åˆ†é…æ¯”ä¾‹</th>
                    </tr>
                    <tr>
                        <td>5F</td>
                        <td>${document.getElementById('f5Ratio').value}</td>
                    </tr>
                    <tr>
                        <td>6F-15F</td>
                        <td>${document.getElementById('f6_15Ratio').value}</td>
                    </tr>
                    <tr>
                        <td>16F-26F</td>
                        <td>${document.getElementById('f16_26Ratio').value}</td>
                    </tr>
                </table>
                ` : `
                <table style="width: auto; margin-left: auto; margin-right: auto;">
                    <tr>
                        <th>æ¨“å±¤</th>
                        <th>åˆ†é…æ¯”ä¾‹</th>
                    </tr>
                    ${Object.keys(state.floorRatios).sort((a, b) => parseInt(a) - parseInt(b)).map(floor => `
                    <tr>
                        <td>${floor}</td>
                        <td>${state.floorRatios[floor]}</td>
                    </tr>
                    `).join('')}
                </table>
                `}
            </body>
            </html>
            `;
            
            // å‰µå»ºBlobå°è±¡
            const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
            
            // å‰µå»ºä¸‹è¼‰éˆæ¥
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `å¸ƒè‰åˆ†æ´¾_${new Date().toISOString().slice(0,10)}.xls`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        window.onload = initApp;
    </script>
</body>
</html>